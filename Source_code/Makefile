# CC=gcc or clang or gcc-13 (on OSX)
CC=gcc

# If a scanner+parser is needed.
LEX=flex
YACC=bison
YFLAGS=-d -v -t #-Wcounterexamples

# Math, big numbers and SDL2 fonts
LDLIBS=-lm -lgmp -lSDL2_gfx -lSDL2_ttf -lSDL2_image # -lSDL2_mixer

# The DEBUG_LEVEL (OFF, CRITICAL, ERROR, WARNING, INFO, TRACE)
# is set by default to WARNING in error.h.
# To set it on the command line, force compilation and set it.
# Example: make -B CFLAGS="-DDEBUG_LEVEL=INFO" to see all debug messages
# above the 'INFO' level.

# clang 14.0.3 does implement the C23 feature __VA_OPTS__ but issues a spurious
# warning. The -Wno-gnu-zero-variadic-macro-arguments disables this warning.
# This flag is ignored by gcc (which implements __VA_OPTS__ without any warning).
override CFLAGS += -std=gnu2x -MMD -Wall -pedantic -Wextra -Wshadow -Wpointer-arith	\
-Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wno-gnu-zero-variadic-macro-arguments

# For MacOS (assuming recent homebrew)
ifeq ($(shell uname -s), Darwin)
	CPPFLAGS+=-I/opt/homebrew/include
	LDFLAGS+=-L/opt/homebrew/lib
endif

LDLIBS += $(shell sdl2-config --libs)
LDFLAGS += $(shell sdl2-config --cflags)

SOURCES := $(wildcard *.c)
OBJECTS := $(SOURCES:%.c=%.o)
DEPS := $(SOURCES:%.c=%.d)

# Compilation in debug mode by default, to use gdb and valgrind. Warnings produce an error.
all: CFLAGS += -g -O0
all: projet

# Once the program works, optimized mode (and no error in case of warning).
nowerror: CFLAGS += -O3
nowerror: projet

# Add parser.o scan.o if bison/flex interface.
projet: $(OBJECTS)
	$(CC) -o $@ $(LDFLAGS) $(CFLAGS) $^ $(LDLIBS)

# Include dependancies generated by gcc -MMD.
-include $(DEPS)

# Clean all.
.PHONY: clean
clean:
	rm -rf projet *.o *.d TAGS core
